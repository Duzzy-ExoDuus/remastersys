#!/bin/bash
###################################################################
#  REMASTERSYS                                                    #
#    Under the GNU GPL2 License                                   #
#    Copyright (C) 2021-2023 Daniel "Nerun" Rodrigues             #
#    Copyright (C) 2007-2013 Tony "Fragadelic" Brijeski           #
#    Full copyright notice: /usr/share/doc/remastersys/copyright  #
###################################################################

# SYSTEM LOCALIZATION
# Target to file:
# /usr/share/locale/(language code)/LC_MESSAGES/remastersys-skelcopy.mo
TEXTDOMAIN=remastersys-skelcopy

Superuser=$"ERROR: This script must run as superuser. Try with \"sudo\"."

# LIBRARIES
. /usr/lib/remastersys/libremastersys.sh

IsRoot # libremastersys.sh

backupSkel(){
    if [ ! -d /etc/remastersys/skel-backup ]; then
        mkdir /etc/remastersys/skel-backup
        # -T do not includes the directory itself, but copy all it's contents
        cp -rT /etc/skel /etc/remastersys/skel-backup
    fi
}

if [ "$1" = "help" -o "$1" = "--help" -o "$1" = "" ]; then
    GiveUserHelp # libremastersys.sh
elif [ "$1" = "clear" ]; then
    # First: make a backup of Debian original files if there is no backup
    backupSkel
    
    # Second: clear skel
    # {*,.[^.]*} means all files and directories, hidden or not
    # [^.] excludes directories "." and ".."
    rm -rf /etc/skel/{*,.[^.]*}
    
    # Third: if there is a backup of Debian original files, restore it
    if [ -d /etc/remastersys/skel-backup ]; then
        cp -rT /etc/remastersys/skel-backup /etc/skel/
        rm -rf /etc/remastersys/skel-backup
    fi
else
    # First: make a backup of Debian original files if there is no backup
    backupSkel
    
    SKELUSER="$1"

    SKELFOLDER=$(grep "^$SKELUSER:" /etc/passwd | awk -F ":" '{print $6}')

    if [ -d "$SKELFOLDER" ]; then
        cd $SKELFOLDER
        echo $"Cleaning up /etc/skel of the files we will copy over."
        rm -rf /etc/skel/.bacon
        rm -rf /etc/skel/.xscreensaver
        rm -rf /etc/skel/.gconf
        rm -rf /etc/skel/.bashrc
        rm -rf /etc/skel/.profile
        rm -rf /etc/skel/.gconf
        rm -rf /etc/skel/.gnome2
        rm -rf /etc/skel/.config
        rm -rf /etc/skel/.local
        rm -rf /etc/skel/.icewm*
        rm -rf /etc/skel/.fvwm*
        rm -rf /etc/skel/.afterstep*
        rm -rf /etc/skel/.gtkrc*
        rm -rf /etc/skel/.mate*
        rm -rf /etc/skel/.qt*
        rm -rf /etc/skel/.kde*
        rm -rf /etc/skel/.pekwm
        rm -rf /etc/skel/.razor
        rm -rf /etc/skel/.wbar
        rm -rf /etc/skel/.mplayer
        echo $"Copying config files to /etc/skel."
        rsync -a --ignore-missing-args .bacon /etc/skel/
        rsync -a --ignore-missing-args .xscreensaver /etc/skel
        [ -f /etc/skel/.xscreensaver ] && sed -i -e "s/$SKELUSER//g" /etc/skel/.xscreensaver
        rsync -a --ignore-missing-args .gconf /etc/skel/
        rsync -a --ignore-missing-args .bashrc /etc/skel/
        rsync -a --ignore-missing-args .profile /etc/skel/
        rsync -a --ignore-missing-args .gnome2 /etc/skel/
        rsync -a --ignore-missing-args .config /etc/skel/
        rsync -a --ignore-missing-args .local /etc/skel/
        rsync -a --ignore-missing-args .icewm* /etc/skel/
        rsync -a --ignore-missing-args .fvwm* /etc/skel/
        rsync -a --ignore-missing-args .afterstep* /etc/skel/
        rsync -a --ignore-missing-args .mate* /etc/skel/
        rsync -a --ignore-missing-args .gtkrc* /etc/skel/
        rsync -a --ignore-missing-args .qt* /etc/skel/
        rsync -a --ignore-missing-args .kde* /etc/skel/
        rsync -a --ignore-missing-args .pekwm /etc/skel/
        rsync -a --ignore-missing-args .razor /etc/skel/
        rsync -a --ignore-missing-args .wbar /etc/skel/
        rsync -a --ignore-missing-args .mplayer /etc/skel/
        rm -rf /etc/skel/.config/chromium
        rm -rf /etc/skel/.config/gcalendar
        rm -rf /etc/skel/.config/google-chrome
        rm -rf /etc/skel/.config/midori/cookies.*
        rm -rf /etc/skel/.config/midori/history.*
        rm -rf /etc/skel/.config/midori/tabtrash.*
        rm -rf /etc/skel/.config/midori/running*
        rm -rf /etc/skel/.config/midori/bookmarks.*
        rm -rf /etc/skel/.config/user-dirs.*
        rm -rf /etc/skel/.gconf/system/networking
        rm -rf /etc/skel/.local/gvfs-metadata
        rm -rf /etc/skel/.local/share/gvfs-metadata
        rm -rf /etc/skel/.local/share/applications/wine-*
        rm -rf /etc/skel/.local/share/Trash
        rm -rf /etc/skel/.local/share/akonadi
        rm -rf /etc/skel/.local/share/webkit
        rm -rf /etc/skel/.kde/share/apps/klipper
        rm -rf /etc/skel/.kde/share/apps/nepomuk
        rm -rf /etc/skel/.kde/share/apps/RecentDocuments/*
        # Gnome 2 keyrings
        rm -rf /etc/skel/.gnome2/keyrings/{*,.[^.]*}
        # Gnome 3 keyrings
        rm -rf /etc/skel/.local/share/keyrings/{*,.[^.]*}
        find /etc/skel/ | grep "$SKELUSER" | xargs rm -rf '{}'
        find /etc/skel/ -name "*socket*" | xargs rm -rf '{}'
        find /etc/skel/ -name "*cache*" | xargs rm -rf '{}'
        grep -Rl "$SKELUSER" /etc/skel | xargs rm -rf '{}'
        chown -R root:root /etc/skel
    else
        echo $"$1 either not found or doesn't have a proper home folder. Exiting."
        exit 1
    fi
fi

