#!/bin/bash

printf "\n New version number: "
read version

author="Daniel Dias Rodrigues <danieldiasr@gmail.com>"
url="https://github.com/nerun/remastersys"

# ==============================================================================
# REMASTERSYS ==================================================================
# ==============================================================================

# UPDATE VERSION
echo "VERSION=\"$version\"" > ./remastersys/etc/remastersys/remastersys.version

# MANPAGES PREPARATION
# gzip deletes remastersys.1 file by default, remaining only remastersys.1.gz
gzip remastersys/usr/share/man/man1/remastersys.1

# CHANGELOG UPDATE
cd remastersys/usr/share/doc/remastersys
mv changelog changelog.old

changelogRead(){
	read changes
	if [ "$changes" != "f" ]; then
		echo "	* "$changes >> changelog
		echo ""
		cat changelog
		changelogAsk
	else
		echo "" >> changelog
		echo " -- $author  "$(date -R) >> changelog
		echo "" >> changelog
	fi
}

changelogAsk(){
	echo ""
	echo " Write changes, then write \"f\" in a new line and press \"ENTER\" when finished."
	changelogRead
}

echo "remastersys ($version) unstable; urgency=low" > changelog
echo "" >> changelog
changelogAsk
cat changelog.old >> changelog
rm changelog.old

# Creating changelog.gz
# gzip deletes changelog file by default, remaining only changelog.gz
gzip changelog

# MOVING LOCALES .po AND .POT
cd ../..
cd ./locale/pt_BR/LC_MESSAGES
# /remastersys/remastersys/usr/share/locale/pt_BR/LC_MESSAGES
mv *.po ../../../../../..
mv *.pot ../../../../../..

# /DEBIAN UPDATE

# Move up to ./remastersys
cd ../../../../..

# md5sum
find . -type f | grep -v "DEBIAN" | sort | xargs md5sum | sed 's/ \./ /g' > ./DEBIAN/md5sums
# conffiles
find ./etc -type f | sort | sed 's/^.//g' > ./DEBIAN/conffiles

# md5sum for conffiles, but words inverted, to be inserted in control file
while read line; do
    echo ' '$(tac -s ' ' <<< $(md5sum .$line | sed 's/ .\/etc/\/etc/g')) >> ./DEBIAN/control-conffiles.tmp
done < ./DEBIAN/conffiles

# Move down to ./remastersys/DEBIAN
cd DEBIAN

# Calculate folder size
size=$(du -s ../../remastersys | cut -f 1)

echo "Package: remastersys
Priority: optional
Section: system
Installed-Size: $size
Maintainer: $author
Architecture: all
Version: $version
Depends: awk, bash, coreutils, dialog, fdisk, findutils, grub-pc, hwdata, laptop-detect, live-boot-initramfs-tools, live-boot, live-config-sysvinit | live-config-systemd, live-config, mkisofs | genisoimage, mount, os-prober, passwd, rsync, sed, squashfs-tools, sudo, syslinux | xorriso, syslinux-utils, util-linux, zstd
Conffiles:" > control

cat control-conffiles.tmp >> control
rm control-conffiles.tmp

echo "Homepage: $url
Description: Remaster and create backups of the Debian system
 Remastersys allows you to create a Live CD/DVD distribution or make a backup
 of the system installed on your machine." >> control

# Get back to Remastersys GitHub root folder
cd ../..

# ==============================================================================
# REMASTERSYS-GUI ==============================================================
# ==============================================================================

# down to GUI
cd remastersys-gui

# md5sum
find . -type f | grep -v "DEBIAN" | sort | xargs md5sum | sed 's/ \./ /g' > ./DEBIAN/md5sums

# Move down to ./remastersys-gui/DEBIAN
cd DEBIAN

# DEBIAN/CONTROL

# Calculate folder size
sizegui=$(du -s ../../remastersys-gui | cut -f 1)

echo "Package: remastersys-gui
Priority: optional
Section: system
Installed-Size: $sizegui
Maintainer: $author
Architecture: all
Version: $version
Depends: gparted, read-edid, remastersys (>= $version), xterm, yad
Homepage: $url
Description: Remaster and create backups of the Debian system
 This is the visual interface of Remastersys." > control

# Get back to Remastersys GitHub root folder
cd ../..

# ==============================================================================
# PACKAGING ====================================================================
# ==============================================================================

# Rename remastersys folder for packaging
name="remastersys_"$version"_all"
namegui="remastersys-gui_"$version"_all"

mv remastersys $name
mv remastersys-gui $namegui

# Packaging
dpkg-deb -b --root-owner-group $name
dpkg-deb -b --root-owner-group $namegui

# ==============================================================================
# RESTORATION ==================================================================
# ==============================================================================

# folders names
mv $name remastersys
mv $namegui remastersys-gui

# delete gziped changelogs and restore single textual changelog
gzip -d ./remastersys/usr/share/doc/remastersys/changelog.gz

# manpages restoration
gzip -d ./remastersys/usr/share/man/man1/remastersys.1.gz

# .po and .pot restoration
mv *.po ./remastersys/usr/share/locale/pt_BR/LC_MESSAGES
mv *.pot ./remastersys/usr/share/locale/pt_BR/LC_MESSAGES

